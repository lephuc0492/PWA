<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple PWA — Install Prompt Demo</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;display:flex;align-items:center;justify-content:center;flex-direction:column;min-height:100vh;margin:0;background:#f5f7fb}
    .card{background:white;border-radius:12px;padding:20px;box-shadow:0 6px 20px rgba(10,20,40,0.08);max-width:420px;width:90%;text-align:center}
    button{appearance:none;padding:10px 16px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
    #installBtn{background:#007bff;color:white;margin-top:12px;display:none}
    .hint{font-size:14px;color:#555;margin-top:8px}
    .ios-hint{background:#fffbe6;padding:10px;border-radius:8px;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Demo PWA — Cài như ứng dụng native</h2>
    <p>Truy cập trang này trên Android (Chrome) hoặc thiết bị hỗ trợ PWA để hiển thị nút cài đặt.</p>
    <button id="installBtn">Cài ứng dụng</button>
    <div id="status" class="hint">Tình trạng: chưa cài</div>
    <div id="ios" class="ios-hint" style="display:none">
      Trên iOS (Safari): dùng nút <strong>Share → Add to Home Screen</strong> để thêm ứng dụng.
    </div>
  </div>

<script>
// --- Tạo manifest động (không cần file manifest.json riêng) ---
const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='%234CAF50'/><text x='50%' y='55%' font-size='72' text-anchor='middle' fill='white' font-family='Arial'>PWA</text></svg>`;
const encodedSvg = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
const manifest = {
  name: 'Simple PWA Demo',
  short_name: 'PWA Demo',
  start_url: '.',
  display: 'standalone',
  background_color: '#ffffff',
  theme_color: '#4CAF50',
  icons: [
    { src: encodedSvg, sizes: '192x192', type: 'image/svg+xml' }
  ]
};
const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
const manifestLink = document.createElement('link');
manifestLink.rel = 'manifest';
manifestLink.href = manifestURL;
document.head.appendChild(manifestLink);

// --- Service worker: tạo động (không cần file sw.js riêng) ---
const swCode = `
const CACHE = 'pwa-demo-v1';
const ASSETS = ['/', './'];
self.addEventListener('install', event => {
  self.skipWaiting();
  event.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)));
});
self.addEventListener('activate', event => {
  event.waitUntil(self.clients.claim());
});
self.addEventListener('fetch', event => {
  event.respondWith(caches.match(event.request).then(r => r || fetch(event.request)));
});
`;
const swBlob = new Blob([swCode], {type: 'text/javascript'});
const swURL = URL.createObjectURL(swBlob);

// Đăng ký service worker nếu trình duyệt hỗ trợ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(swURL).then(reg => {
    console.log('Service worker registered from blob:', reg);
  }).catch(err => console.warn('SW register failed:', err));
}

// --- Xử lý beforeinstallprompt để hiển thị nút cài đặt trên Android/Chromium ---
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
const status = document.getElementById('status');

window.addEventListener('beforeinstallprompt', (e) => {
  // Ngăn trình duyệt hiển thị prompt mặc định
  e.preventDefault();
  deferredPrompt = e; // lưu event để gọi sau
  installBtn.style.display = 'inline-block';
  status.textContent = 'Tình trạng: sẵn sàng để cài';
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('userChoice', result);
  if (result.outcome === 'accepted') {
    status.textContent = 'Tình trạng: người dùng chấp nhận cài';
  } else {
    status.textContent = 'Tình trạng: người dùng từ chối cài';
  }
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

window.addEventListener('appinstalled', () => {
  status.textContent = 'Tình trạng: đã cài đặt';
  console.log('App installed');
});

// iOS không có beforeinstallprompt — hiển thị hướng dẫn
function isiOS() {
  return /iphone|ipad|ipod/i.test(navigator.userAgent);
}
function isInStandaloneMode() {
  return ('standalone' in window.navigator) && window.navigator.standalone;
}
if (isiOS() && !isInStandaloneMode()) {
  document.getElementById('ios').style.display = 'block';
}

// Lưu ý: để PWA hoạt động như native, cần chạy qua HTTPS hoặc localhost.
console.log('PWA demo ready. Serve via https or localhost to test install flow.');
</script>
</body>
</html>
